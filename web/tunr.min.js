/*
 *  tunr
 *  by Jason Mooberry (jasonmoo@me.com)
 *  created 11/04/10
 */
Array.prototype.average=function(){for(var a=0,b=0;b<this.length;b++)a+=this[b];return a/this.length};
_tunr={time:null,accuracy:null,scores:[],add_score:function(a){this.scores.push(a);if(this.scores.length===3){stopwatch.stop();a=100-Math.round(this.scores.average()*10)*0.1;_tunr.time=stopwatch.time;_tunr.accuracy=a;$("#stopwatch, #steps").fadeOut("slow");$("#report_score").find("#time").text(stopwatch.toString()).end().find("#accuracy").text(a+"%").end().find("#post").text("I played #tunr in "+stopwatch.toString()+" with "+a+"% accuracy. http://is.gd/fYgKn");$("#report_score_wrapper").slideDown(1E3,
function(){var b=$(this).offset().top;$("body").animate({scrollTop:b},1E3,function(){$("#report_score").fadeIn(1200)})})}}};function Stopwatch(a){this.readout=$(a);this.time=0;this.active=false;this.interval=null}
$.extend(Stopwatch.prototype,{start:function(){if(!this.active){var a=this;this.active=true;a.update_clock();a.interval=setInterval(function(){a.time++;a.update_clock()},1E3)}},stop:function(){this.active=false;clearInterval(this.interval)},reset:function(){this.time=0;this.update_clock()},update_clock:function(){this.readout.text(this.toString())},toString:function(){var a=~~(this.time/60),b=this.time%60;b=b<10?"0"+b:b;return a+":"+b}});stopwatch=new Stopwatch("#stopwatch div");
$("#facebook, #twitter").click(function(a){var b=$(this).attr("id");window.open("http://tunr.jasonmooberry.com:3000/"+b+"?time="+_tunr.time+"&accuracy="+_tunr.accuracy,"auth_window","width=1000,height=650,scrollbars=0,menubar=0,resizable=0,toolbar=0");$(window).unbind("."+b).bind("success."+b,function(){$(a.target).unbind().replaceWith('<div id="'+b+'_done">Done!</div>');$("#post_buttons div[id$=_done]")})});
$("#mybox").bind("mousedown.stopwatch",function(){$("#stopwatch, #steps").fadeIn("slow",function(){stopwatch.start()});$(this).unbind(".stopwatch")});$("#sineblocks, #threeblocks, #colorblocks").mousedown(function(a){a.preventDefault()});function sinebox(a){a.style.top=Math.sin(+new Date/32*0.1)*80+160+"px";setTimeout(function(){sinebox(a)},10)}sinebox($("#sinebox")[0]);setTimeout(function(){$("#sineblocks div").fadeIn(1200);$("#steps div:nth-child(1)").css("background","green")},1E3);
$("#mybox").mousedown(function(a){a.preventDefault();$("#sineblocks").css("cursor","url(cur_updown.png), move");var b=[],c=$("#sineblocks").offset().top+20,g=$("#sineblocks").height()-$(a.target).height()-20,h=$("#sinebox");$(document).bind({"mousemove.mybox":function(e){e=e.pageY-c;e=Math.min(Math.max(e,20),g);a.target.style.top=e+"px";b.push(Math.abs(e-parseInt(h[0].style.top.match(/^-?\d+/)[0],10)));if(b.length>200){b=b.slice(-200);e=b.average();if(e<12){_tunr.add_score(e);$("#sineblocks").css("cursor",
"inherit");$(document).unbind(".mybox");$("#mybox").unbind();sinebox($("#mybox")[0]);$("#threeblocks").triggerHandler("start")}}},"mouseup.mybox":function(){$("#sineblocks").css("cursor","inherit");$(document).unbind(".mybox")}})});
function push_down(a){var b=a.find("div:last"),c=b.height(),g=parseInt(b.css("margin-top").match(/^-?\d+/)[0],10);if(c===0)return setTimeout(function(){push_down(a)},30);a.prepend(a.find("div:last").detach().css({height:0,margin:0}));var h=a.find("div:first");(function e(){setTimeout(function(){var i=parseInt(h.css("margin-top").match(/^-?\d+/)[0],10);if(h.height()<c){h.height(h.height()+1);return e()}else if(i<g){h.css("margin-top",i+1);if(i+1==g)return push_down(a);return e()}push_down(a)},30)})()}
function shrink_up(a){if(a.find("div:last").height()===0)return setTimeout(function(){shrink_up(a)},30);a.find("div:first").remove();a.append(a.find("div:first").clone());var b=a.find("div:first-child");(function c(){setTimeout(function(){var g=parseInt(b.css("margin-top").match(/^-?\d+/)[0],10);if(g>0){b.css("margin-top",g-1);return c()}else if(b.height()>0){b.height(b.height()-1);if(b.height()==0)return shrink_up(a);return c()}shrink_up(a)},30)})()}
function block_mousedown(a){a.preventDefault();$("#threeblocks").css("cursor","url(cur_up.png), move");var b=[],c=$(this).offset(),g=$("#threeblocks").offset(),h=a.pageY-c.top+g.top,e=$("#up_bar div:last"),i=e.position().top-$(this).position().top;line_top=$("#line").position().top;$(this).addClass("pushing").bind({"mousemove.blocks":function(d){d.preventDefault();$(this).addClass("inair");if($("div.inair").length===3&&$("#threeblocks").data("win")===false){$("#threeblocks").data("win",true);$("div.inair:not(.pushing)").each(function(){play_block($(this))})}d=
d.pageY-h;d=Math.min(Math.max(d,20),300);a.target.style.top=d+"px";b.push(Math.abs(d+i-e.position().top));b.length>20&&b.average()>20&&reset_blocks(true)},"mouseup.blocks":function(d){d.preventDefault();$("#threeblocks").css("cursor","inherit");var f=$(a.target);f.removeClass("pushing");if(f.position().top+f.height()>line_top)return reset_blocks(true);if($("#threeblocks").data("win")){_tunr.add_score(b.average());play_block(f);return $("#colorblocks").triggerHandler("start")}f.unbind(".blocks");(function k(){f[0]._tunr.timeout=
setTimeout(function(){var j=f.position().top;if(j<300){f.css("top",j+1);return k()}f.removeClass("inair").bind("mousedown.blocks",block_mousedown)},30)})()},"mouseout.blocks":function(d){d.preventDefault();$("#threeblocks").css("cursor","inherit");reset_blocks(true)}})}
function play_block(a){a.unbind(".blocks").addClass("play");clearTimeout(a[0]._tunr.timeout);(function b(){a[0]._tunr.timeout=setTimeout(function(){var c=a.position().top;if(c<300){a.css("top",c+1);return b()}(function g(){a[0]._tunr.timeout=setTimeout(function(){var h=a.position().top;if(h>20){a.css("top",h-1);return g()}b()},30)})()},30)})()}
function reset_blocks(a){a=a||false;$("#blocks div").unbind(".blocks").removeClass("inair pushing play").each(function(b,c){c._tunr=c._tunr||{timeout:null}});$("#threeblocks").data("win",false).css("cursor","inherit");a?$("#blocks div").each(function(b,c){clearTimeout(c._tunr.timeout)}).animate({top:300},300,function(){$(this).bind("mousedown.blocks",block_mousedown)}):$("#blocks div").bind("mousedown.blocks",block_mousedown)}
$("#threeblocks").bind("start",function(a){$("#steps div:nth-child(2)").css("background","green");$("#threeblocks_wrapper").slideDown(1E3,function(){var b=$(this).offset().top;$("body").animate({scrollTop:b},1E3,function(){push_down($("#down_bar"));shrink_up($("#up_bar"));reset_blocks();$(a.target).fadeIn(1200)})})});function circle(){var a=+new Date/700;return{x:34*Math.cos(a),y:34*Math.sin(a)}}
function color_spin(a){var b=circle();a.style.top=b.y-100+"px";a.style.left=b.x-100+"px";setTimeout(function(){color_spin(a)},10)}$("#colorblocks").bind("start",function(a){$("#steps div:nth-child(3)").css("background","green");$("#colorblocks_wrapper").slideDown(1E3,function(){var b=$(this).offset().top;$("body").animate({scrollTop:b},1E3,function(){$(a.target).fadeIn(1200)})});color_spin($("#color_box img")[0])});
$("#my_color_box img").mousedown(function(a){a.preventDefault();var b=[],c=$(this).offset(),g=$(this).parent().offset(),h=a.pageX-c.left+g.left,e=a.pageY-c.top+g.top,i=$("#color_box img")[0];$(document).bind({"mousemove.mycolorbox":function(d){d.preventDefault();var f=Math.max(Math.min(d.pageX-h,60),-260);d=Math.max(Math.min(d.pageY-e,60),-260);a.target.style.left=f+"px";a.target.style.top=d+"px";f=Math.abs(f-parseInt(i.style.top.match(/^-?\d+/)[0],10))+Math.abs(d-parseInt(i.style.left.match(/^-?\d+/)[0],
10));b.push(f);if(b.length>300){b=b.slice(-300);f=b.average();if(f<56){_tunr.add_score(f/2);$(document).unbind(".mycolorbox");$("#my_color_box img").unbind();color_spin($("#my_color_box img")[0])}}},"mouseup.mycolorbox":function(d){d.preventDefault();$(document).unbind(".mycolorbox")}})});